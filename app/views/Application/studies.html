#{extends 'main.html'/}
#{set title:'Studies'/}

#{set 'moreScripts'}
<script>
	function params(url) {
		"use strict";
		var e,
			r = /[?&](\w+)=?([a-zA-Z_0-9\-]*)/g,
			p = {};
		while (e = r.exec(url)) {
			p[e[1]] = e[2];
		}
		return p;
	}
	$(function() {
		"use strict";
		$('th.header').on('click', function() {
			var search = $.extend(params(window.location.search), {
				order: this.id,
				sort: $(this).hasClass('headerSortDown') ? "desc" : "asc",
				page: 0
			});
			window.location = window.location.pathname + "?" + $.param(search);
		});
	});
</script>
#{/set}

<h1>Search results<small style="padding-left: 1em">${studyCount} matching subjects</small></h1>
<br>
<table id="studies" class="table table-striped table-bordered">
	<thead>
		<tr>
			#{list items:['patient.pat_name':'Name', 'patient.pat_id':'Subject ID', 'patient.pat_birthdate':'Date of Birth', 'study_desc':'Study Description', 'study_datetime':'Date of Study']}
			<th id="${_.key}" class="header#{if _.key == params.order} headerSort${params.sort == 'desc' ? 'Up' : 'Down'}#{/if}">${_.value}
			#{/list}
			<th>Project
			<th>
		</tr>
	</thead>
	<tbody>
		#{list studies}
		<tr>
			<td>#{a @patient(_.patient.pk)}${_.patient.pat_name ? _.patient.pat_name.formatAsName() : 'UNKNOWN'}#{/a}
			<td>${_.patient.pat_id}
			<td>${_.patient.pat_birthdate?.formatAsDate()}
			<td>${_.study_desc}
			<td>${_.study_datetime?.format()}
			<td>${_.getProjectAssociation()?.project}#{if _.getProjectAssociation()?.participationID} (${_.getProjectAssociation()?.participationID})#{/if}
			<td>#{a @clipboard(controllers.Application.ClipboardOp.ADD, _.class.simpleName, _.pk), class: 'clipboard'}<i class="icon-download-alt icon-large"></i>#{/a}
		</tr>
		#{/list}
	</tbody>
</table>

#{if Math.ceil(studyCount / util.Properties.pageSize()) > 1}
<div class="pagination pagination-centered">
  <ul>
    #{if page}
    <li class="prev"><a href="${request.url.replaceFirst("page=\\d+", "page=" + (page - 1))}">&larr; Prev</a>
    #{/if}
    #{else}
    <li class="prev disabled"><a href="#">&larr; Prev</a>
    #{/else}
    #{list items:util.Util.pages(studyCount, util.Properties.pageSize(), page + 1)}
    #{if _}<li#{if _ == page + 1} class="active"#{/if}><a href="${request.url.replaceFirst("page=\\d+", "page=" + (_ - 1))}">${_}</a>#{/if}#{else}<li class="disabled"><a href="#">â€¦</a>#{/else}
    #{/list}
    #{if page < Math.ceil(studyCount / util.Properties.pageSize()) - 1}
    <li class="next"><a href="${request.url.replaceFirst("page=\\d+", "page=" + (page + 1))}">Next &rarr;</a>
    #{/if}
    #{else}
    <li class="next disabled"><a href="#">Next &rarr;</a>
    #{/else}
  </ul>
</div>
#{/if}
