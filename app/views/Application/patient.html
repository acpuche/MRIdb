#{extends 'main.html'/}
#{set title:'Patient'/}
#{set 'moreScripts'}
<script>
	$(function() {
		$('select').on('change', function() {
			if ($("option:selected", this).val() == -1) {
				var projectName = prompt("Project name");
				if (!projectName) {
					return;
				}
				$(this).siblings('input[name=projectName]').val(projectName);
				$(this).siblings('input[name=participationID]').val('');
				$(this).closest('form').submit();
			} else {
				$(this).siblings('input[name=participationID]').attr("disabled", !$("option:selected", this).val());
			}
		});
	});
</script>
#{/set}

<h1>${patient.pat_id} - ${patient.pat_name?.formatAsName()} - ${patient.pat_birthdate?.formatAsDate()}</h1>
<hr>

#{list patient.studies, as: 'study'}
<h3 id="#${study.pk}" style="display: inline">${patient.pat_id} ${study.study_desc} ${study.study_datetime?.format()}</h3> #{a @clipboard(controllers.Application.ClipboardOp.ADD, study.class.simpleName, study.pk), class: 'clipboard'}<img src="@{'/public/images/attach.png'}">#{/a}
#{form @associate(), method: 'post', class: 'form-inline'}
	Project:
	<select name="projectID">
		<option></option>
		#{list models.Project.find("order by name").fetch()}
		<option value="${_.id}"#{if _.equals(study.getProjectAssociation()?.project)} selected#{/if}>${_.name}</option>
		#{/list}
		<option value="-1">New project...</option>
	</select>
	&nbsp;
	Identifier:
	<input type="text" name="participationID" value="${study.getProjectAssociation()?.participationID}"#{ifnot study.getProjectAssociation()} disabled#{/ifnot}>
	&nbsp;
	<input type="hidden" name="study.pk" value="${study.pk}">
	<input type="hidden" name="projectName">
	<input type="submit" class="btn" value="Update">
#{/form}
<ul class="thumbnails">
	*{ #{list study.series.findAll{util.Dicom.renderable(it)}.sort{it.series_no as int}, as: 'series'} }*
	#{list study.series.sort{it.series_no as int}, as: 'series'}
	<li>
		<a href="#{if util.Dicom.renderable(series)}@{series(series.pk)}#{/if}#{else}##{/else}" class="thumbnail">
			<img src="@{'/public/images/spinner.gif'}" alt="@{image(series.pk, 128)}">
			<div class="caption">${(series.series_no + " " + series.series_custom1).ellipsis(20)}</div>
		</a>
	</li>
	#{/list}
</ul>
#{/list}
