#{extends 'main.html'/}
#{set title:'Series'/}
#{set 'moreScripts'}
<script>
    $('a.imagej').on('click', function() {
        $('#imagej').html("<applet archive=@{'/public/applets/ij.jar'} code=ij.ImageJApplet.class width=0 height=0><param name=adjustBrightnessContrast value=true><param name=url1 value=@@{imagej(series.pk)}&.dcm><div class='alert-message error'><p>Your browser does not support Java, please contact computing support</p></div></applet>");
    });
</script>
#{/set}

<h2 style="display: inline">${series.study.patient.pat_id} - ${series.study.patient.pat_name?.formatAsName()} - ${series.study.study_datetime?.format()} - ${series.series_custom1}(${series.series_no})</h2> #{a @clipboard(controllers.Application.ClipboardOp.ADD, series.class.simpleName, series.pk), class: 'clipboard'}<img src="@{'/public/images/attach.png'}">#{/a} #{stats series}%s files (%s)#{/stats}
<p>
 #{if echoes.size() > 1 && series.instances.size() > 1}#{list echoes}#{a @download(series.pk, "dcm", _index)}DICOM${_index}#{/a}#{/list}#{/if}#{else}#{a @download(series.pk)}<img src="@{'/public/images/dicom.png'}" alt="DICOM">#{/a}#{/else}#{a @download(series.pk, 'nii')}<img src="@{'/public/images/nifti.png'}" alt="NIfTI">#{/a}#{a @download(series.pk, 'img')}<img src="@{'/public/images/analyze.png'}" alt="Analyze">#{/a}
 &nbsp;<a href="#" class="imagej"><img src="@{'/public/images/imagej.png'}" alt="ImageJ"></a> <a href="//${request.domain}:8080/weasis-pacs-connector/viewer.jnlp?seriesUID=${series.series_iuid}"><img src="@{'/public/images/weasis.png'}" alt="Weasis"></a>

<div class="row">
	<div class="span14">
		<h3>Subject details</h3>
		<table class="bordered-table">
			<thead>
				<tr>
					<th>PatientID</th>
					<th>Name</th>
					<th>Sex</th>
					<th>Date of birth</th>
					<th>Weight</th>
					<th>Age</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>${series.study.patient.pat_id}</td>
					<td>${series.study.patient.pat_name?.formatAsName()}</td>
					<td>${series.study.patient.pat_sex}</td>
					<td>${series.study.patient.pat_birthdate?.formatAsDate()}</td>
					<td>${series.study.patient.pat_attrs.get('PatientWeight')} kg</td>
					<td>${series.study.patient.pat_birthdate?.formatAsRelativeAge(series.study.study_datetime)}</td>
				</tr>
			</tbody>
		</table>
		
		<h3>Study details</h3>
		<table class="bordered-table">
			<thead>
				<tr>
					<th>Study description</th>
					<th>Date of scan</th>
					<th>Time of scan</th>
					<th>Study ID</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>${series.study.study_desc}</td>
					<td>${series.study.study_datetime?.format()}</td>
					<td>${series.study.study_datetime?.time()}</td>
					<td>${series.study.study_id}</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="span1 offset1">
		<ul class="media-grid">
			#{list echoes}
			<li>
				<a href="#" class="imagej">
					<img class="thumbnail" src="@{'/public/images/128x128.gif'}" alt="@{image(series.pk, 128, _index - 1)}">
				</a>
			</li>
			#{/list}
		</ul>
	</div>
</div>

<h3>Image description</h3>
<table class="bordered-table">
	<thead>
		<tr>
			<th>Matrix (cols / rows / slices)</th>
			<th>Pixel spacing (x / y / z)</th>
			<th>In plane phase encoding</th>
			<th>Phase encoding steps</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>${series.instances.iterator().next().inst_attrs.get('Columns')} / ${series.instances.iterator().next().inst_attrs.get('Rows')} / #{NumberOfFrames series/}</td>
			<td>#{PixelSpacing dataset, axis: 'X'/} / #{PixelSpacing dataset, axis: 'Y'/} / #{SliceThickness dataset/}</td>
			<td>#{InPlanePhaseEncodingDirection dataset/}</td>
			<td>#{MRAcquisitionPhaseEncodingStepsInPlane dataset/}</td>
		</tr>
	</tbody>
</table>

<h3>Sequence description</h3>
<table class="bordered-table">
	<thead>
		<tr>
			<th>Seq #
			<th>Protocol name
			<th>Sequence
			<th>Variant
			<th>Receive coil
			<th>Repetition time
			<th>Echo time
			<th>Number of echoes
			<th>Temporal positions
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>${series.series_no}
			<td>${series.series_custom1}
			<td>#{attr dataset, tag:'ScanningSeq'/}
			<td>#{attr dataset, tag:'SeqVariant'/}
			<td>#{ReceiveCoilName dataset/}
			<td>#{RepetitionTime dataset/} ms
			<td>${echoes.collect{it + ' ms'}.join(' / ')}
			<td>${echoes.size()}
			<td>#{attr dataset, tag:'NumberOfTemporalPositions'/}
		</tr>
	</tbody>
</table>

<div id="imagej"></div>
